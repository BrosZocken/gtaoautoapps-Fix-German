;80s per run
;v0.1.0
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;CONFIG
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================

#SingleInstance, Force
#Include %A_ScriptDir%
FileCreateDir, %A_WorkingDir%\images
FileInstall, images\map_button.bmp, %A_WorkingDir%\images\map_button.bmp, 1 ;map button
FileInstall, images\joining_online_button.bmp, %A_WorkingDir%\images\joining_online_button.bmp, 1 ;joining online button
FileInstall, images\browser_tile.png, %A_WorkingDir%\images\browser_tile.png, 1 ;browser tile
FileInstall, images\quick_actions_tile.bmp, %A_WorkingDir%\images\quick_actions_tile.bmp, 1 ;quick actions list tile
FileInstall, images\return_to_map_button.bmp, %A_WorkingDir%\images\return_to_map_button.bmp, 1 ;return to map button(dynasty 8)
FileInstall, images\retry_continue_buttons.bmp, %A_WorkingDir%\images\retry_continue_buttons.bmp, 1 ;retry/continue buttons
FileInstall, images\trade_in_property_menu.bmp, %A_WorkingDir%\images\trade_in_property_menu.bmp, 1 ;trade in property menu
SetKeyDelay, 130, 1
SetMouseDelay, 70
CoordMode, Pixel, Relative
SetTitleMatchMode, 2

if not A_IsAdmin
{
  Run *RunAs "%A_ScriptFullPath%",, UseErrorLevel
  if ErrorLevel != 0
  {
    MsgBox, 48, Error, This script requires administrator privileges! Please run it again with the correct privileges.
    ExitApp
  }
}

;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;HOTKEYS
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
Numpad0:: ;preparation phase start hotkey
  MsgBox, 4,, You're going to start "preparation phase"`n!!!WARNING!!!`n You need to have at least $5,000,000 on your GTA Online's bank account!`n!!!WARNING!!!`nDo you want to continue?
  IfMsgBox, Yes
  {
    ApartmentsPrep()
    Return
  }
  else
    Return

Numpad1:: ;payback phase start hotkey
  MsgBox, 4,, You're going to start "payback phase"`n!!!WARNING!!!`nMake sure that you've prepared the slots!`n!!!WARNING!!!`nDo you want to continue?
  IfMsgBox, Yes
  {
    ApartmentsRun()
    Return
  }
  else
    Return

Numpad2:: ;"panic button" no-save enable hotkey
  saveblockEnable()
Return

Numpad3:: ;"panic button" no-save disable hotkey
  saveblockDisable()
Return

Numpad4:: ;"panic button" reload hotkey
  Reload
Return

Numpad5:: ;"panic button" exit hotkey
  saveblockDisable()
ExitApp
Return

;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;FUNCTIONS
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================
;==================================================================================================================================================================================================================================================================================================================================================================================================================================

ApartmentsRun() ;function that runs "payback phase"
{
  InputBox, runsNum,, How many runs?,
  totaltime := Format("{1:.2f}",((runsNum*80)/60))
  totaltime2 := Format("{1:.2f}",(totaltime/60.0))
  totalpayout := RegExReplace((runsNum*5200000), "(\d)(?=(?:\d{3})+(?:\.|$))", "$1,")
  cashperminute := "3,900,000"
  MsgBox, 4,, Don't press anything after choosing "Yes"!!!`n`nWhole process will take %runsNum% runs -  around %totaltime% minutes(%totaltime2% hours).`n`nYou'll earn around $%totalpayout%.`n`nEstimated $/minute profit: $%cashperminute%.`n`n Do you want to continue?
  IfMsgBox, No
  {
    Return
  }
  else
  {
    WinActivate, Grand Theft Auto V
    QPC(1)
    Loop % runsNum
    {
      ToolTip, Going...(Run %A_index%), 400, 0
      fromSingleToOnline()
      forceSave()
      ApartmentsExchange()
      fromOnlineToSingle()
      Tooltip,,
    }
    MenuMapChecker()
    timer := Round(QPC(0), 2)
    perRun := Round(timer/runsNum, 2)
    saveblockDisable()
    MsgBox End of the line. Rounds passed: %runsNum%. Time passed: %timer%s. Cash earned: $%totalpayout%. Time per run: %perRun%s.
  }
}

ApartmentsPrep() ;function that runs preparation phase
{
  MsgBox, 4,, Don't press anything after choosing "Yes"!!!`n`nWhole process will take around 15 minutes. Do you want to continue?
  IfMsgBox Yes
  {
    PrepTime()
  }
  else
  {
    Return
  }
}

ApartmentsExchange() ;function that trades in all apartments into cheapest one(MUST PREPARE THE SLOTS FIRST !!!!)
{
  tradebutton_y := 80 ;y coordinate of trade-in slot; needed for later loop
  PullUpPhone()
  EnterBrowser()
  EnterDynastyEstate()

  Loop ; Infinite loop to ensure BuyTrashBlocker and TradeInChecker succeed
  {
    BuyTrashBlocker()

    ; Check if the Trade-In menu is found
    if (TradeInChecker() = 0) ; Trade-In menu successfully found
      break

    ; Fallback: Return to the homepage and try again
    MouseMove, 260, 110, 0 ; Example position for fallback click (homepage)
    Click
    Sleep 200
    EnterDynastyEstate() ; Return to Dynasty 8 website
  }

  PressKey("Enter", 50, 1, 300)
  PressKey("Enter", 50, 1, 0)
  ReturnToMapChecker()
  ReturnToMapPress()

  Loop, 9
  {
    counter := A_Index + 1
    Loop ; Infinite loop to ensure BuyTrash and TradeInChecker succeed
    {
      BuyTrash()

      ; 5-second check for TradeInChecker with fallback
      if (TradeInChecker() = 0) ; Trade-In menu successfully found
        break

      ; Fallback: Return to the homepage and try again
      MouseMove, 260, 110, 0 ; Example position for fallback click (homepage)
      Click
      Sleep 200
      EnterDynastyEstate() ; Return to Dynasty 8 website
    }

    tradebutton_y := tradebutton_y + 27
    MouseMove, 70, tradebutton_y, 0
    MouseMove, 70, tradebutton_y, 0
    Click
    PressKey("Enter", 50, 2, 0) ;confirm
    ReturnToMapChecker()
    if (A_Index < 9) ; Skip ReturnToMapPress on the last iteration
      ReturnToMapPress()
  }
  ExitBrowser()
  Sleep 150
}

PrepTime() ;function that prepares all apartment slots so all of them will be worth 550k each
{
  WinActivate, Grand Theft Auto V
  QPC(1)
  tradebutton_y := 80 ;y coordinate of trade-in slot; needed for later loop
  Loop, 10
  {
    counter := A_Index - 1
    Tooltip, Preparing apartment no.(%A_Index%), 400, 0
    fromSingleToOnline()
    forceSave()
    Sleep 50
    PullUpPhone()
    EnterBrowser()
    EnterDynastyEstate()

    Loop ; Infinite loop to ensure BuyEclipse and TradeInChecker succeed
    {
      BuyEclipse()

      ; Check if the Trade-In menu is found
      if (TradeInChecker() = 0) ; Trade-In menu successfully found
        break

      ; Fallback: Return to the homepage and try again
      MouseMove, 260, 110, 0 ; Example position for fallback click (homepage)
      Click
      Sleep 200
      EnterDynastyEstate() ; Return to Dynasty 8 website
    }
    MouseMove, 70, tradebutton_y, 0
    MouseMove, 70, tradebutton_y, 0
    Click
    PressKey("Enter", 50, 2, 0) ;confirm
    Sleep 400
    ExitBrowser()
    PullUpPhone()
    EnterBrowser()
    EnterDynastyEstate()

    Loop ; Infinite loop to ensure BuyTrashBlocker and TradeInChecker succeed
    {
      BuyTrashBlocker()

      ; Check if the Trade-In menu is found
      if (TradeInChecker() = 0) ; Trade-In menu successfully found
        break

      ; Fallback: Return to the homepage and try again
      MouseMove, 260, 110, 0 ; Example position for fallback click (homepage)
      Click
      Sleep 200
      EnterDynastyEstate() ; Return to Dynasty 8 website
    }
    MouseMove, 70, tradebutton_y, 0
    MouseMove, 70, tradebutton_y, 0
    Click
    PressKey("Enter", 50, 2, 0) ;confirm
    tradebutton_y := tradebutton_y + 27
    ReturnToMapChecker()
    ExitBrowser()
    Sleep 150
    fromOnlineToSingle()
    Tooltip,,
  }
  MenuMapChecker()
  timer := Round(QPC(0), 2)
  MsgBox, time needed: %timer%
}

; Optimized PressKey function to handle single presses more efficiently
PressKey(button, presstime, presses, sleeptime)
{
  if (presses = 1) {
    SendInput, {%button% down}
    Sleep %presstime%
    SendInput, {%button% up}
    Sleep %sleeptime%
  } else {
    Loop, %presses%
    {
      SendInput, {%button% down}
      Sleep %presstime%
      SendInput, {%button% up}
      if (presses > 1)
        Sleep 100
      Sleep %sleeptime%
    }
  }
} ;presskey function - very fast, at least faster than send

fromSingleToOnline()
{
  SetMouseDelay, 60
  MenuMapChecker()
  MouseMove, 913, 172, 0
  Click
  Sleep 700
  PressKey("Up", 50, 1, 150)
  PressKey("Enter", 50, 1, 150)
  PressKey("Up", 50, 1, 150)
  Critical
  saveblockDisable()
  Critical, Off
  PressKey("Enter", 60, 2, 100)
  Loop
  {
    ImageSearch, FoundX, FoundY, 867, 766, 984, 783, *80 %A_WorkingDir%\images\joining_online_button.bmp ;eighth image check
    if (ErrorLevel = 0)
    {
      break
    }
    ImageSearch, FoundX, FoundY, 831, 747, 1023, 795, *50 %A_WorkingDir%\images\retry_continue_buttons.bmp ;seventh image check
    if (ErrorLevel = 0)
    {
      Critical
      saveblockDisable()
      Critical, Off
      Sleep 4000
      PressKey("Space", 500, 1, 0)
      break
    }
  }
} ;function that goes from story mode into gta online

MenuMapChecker()
{
  Loop ; Infinite loop to ensure the pause menu is open
  {
    PressKey("Esc", 50, 1, 370) ; Press Esc to open the pause menu
    ImageSearch, FoundX, FoundY, 0, 0, 165, 182, *100 %A_WorkingDir%\images\map_button.bmp ; Check if pause menu is open
  } Until (ErrorLevel = 0) ; Exit the loop only when the pause menu is successfully opened
}

fromOnlineToSingle()
{
  SendInput, {Alt down}
  PressKey("F6", 500, 1, 0)
  SendInput, {Alt up}
  Sleep 30
  PressKey("Enter", 500, 1, 0)
} ;function that goes from gta online to story mode(franklin by default)

saveblockEnable() ;function to enable no-save mode
{
  RunWait %comspec% /c "netsh advfirewall firewall add rule name="GTAOSAVEBLOCK" dir=out action=block remoteip=192.81.241.170-192.81.241.171 enable=yes" ,,Hide
  ShowToolTip("NO SAVING MODE ON")
}

saveblockDisable()
{
  RunWait %comspec% /c "netsh advfirewall firewall delete rule name="GTAOSAVEBLOCK"" ,,Hide
  ShowToolTip("NO SAVING MODE OFF")
} ;function to disable no-save mode

; Optimized PullUpPhone function with timeout
PullUpPhone()
{
  Loop ; Infinite loop to ensure the phone is pulled up
  {
    ; Spam MButton for up to 5 seconds to open the phone
    Loop, 50
    {
      PressKey("MButton", 1, 1, 50) ; Try to open the phone
      ImageSearch, FoundX, FoundY, 920, 647, 943, 672, *80 %A_WorkingDir%\images\quick_actions_tile.bmp ; Check if phone is open
      if (ErrorLevel = 0) ; Phone successfully opened
        Return ; Exit the function only when the phone is successfully opened
      Sleep 100 ; Wait 100ms before checking again
    }

    ; If the phone is not open after 5 seconds, reset it using MenuMapChecker
    MenuMapChecker() ; Ensure the pause menu is open
    PressKey("Esc", 50, 1, 370) ; Close the pause menu to reset the phone
    Sleep 200 ; Small delay after closing the pause menu
  }
} ;function to take out gtao char phone

; Optimized EnterBrowser function with timeout
EnterBrowser()
{
  Loop ; Infinite loop to ensure the browser is entered
  {
    PressKey("Down", 50, 1, 50) ; Navigate down in the phone menu
    ImageSearch, FoundX, FoundY, 914, 696, 948, 729, *100 %A_WorkingDir%\images\browser_tile.png ; Check if browser tile is visible
    if (ErrorLevel = 0) ; Browser tile successfully found
    {
      Sleep 30
      PressKey("Enter", 50, 1, 600) ; Enter the browser
      Return ; Exit the function after successfully entering the browser
    }
  }
} ;function to enter phone's browser

EnterDynastyEstate()
{
  Sleep 100
  MouseMove, 255, 590, 0 ;enter dynasty 8 website
  Sleep 60
  Click
  MouseMove, 310, 450, 1 ;"view property listings"
  Sleep 200
  Click
} ;function to enter dynasty 8 website and then property listings

BuyEclipse()
{
  MouseMove, 240, 270, 0 ;sort from low to high
  Click
  Sleep 100
  MouseMove, 310, 270, 0 ;sort from high to low
  Click
  Sleep 100
  MouseMove, 300, 400, 0 ;choose apartment
  Click
  Sleep 120
  MouseMove, 780, 600, 0 ;select interiors
  Click
  Sleep 100
  PressKey("WheelDown", 10, 3, 10) ;scroll down to show purchase button
  MouseMove, 760, 720, 0
  Sleep 50
  Click
  ;Click, 760 720 ;purchase property
} ;function to buy most expensive apartment available for character

TradeInChecker() ; Function that checks for 5 seconds if the Trade-In menu is found
{
  Loop, 50 ; 50 iterations with 100ms pause each (total 5 seconds)
  {
    ImageSearch, FoundX, FoundY, 27, 49, 150, 66, *80 %A_WorkingDir%\images\trade_in_property_menu.bmp ; Image search for Trade-In menu
    if (ErrorLevel = 0) ; If the menu is found
      return 0 ; Success
    Sleep 100 ; Wait 100ms
  }
  return 1 ; Timeout after 5 seconds
}

ExitBrowser()
{
  MouseMove, 842, 108, 0 ;exit web browser
  Click
  Sleep 300
} ;function to exit phone's browser

BuyTrash()
{
  MouseMove, 310, 270, 0 ;sort from high to low
  Click
  Sleep 100
  MouseMove, 240, 270, 0 ;sort from low to high
  Click
  Sleep 100
  MouseMove, 300, 400, 0 ;choose apartment
  Click
  Sleep 120
  MouseMove, 750, 600, 0 ;purchase property button
  Sleep 50
  Click
} ;function to buy cheapest apartment available for character

BuyTrashBlocker()
{
  BuyTrash()
  Critical
  saveblockEnable()
  Sleep 300
  Critical, Off
} ;function to buy cheapest apartment available for character (modified version for "preparation phase" - this one enables blocker before swap so trade-in value of most expensive apartment will stay but actual cheapest building will be used, resulting in some cheap house in paleto (for example) being worth as much as eclipse tower apartment

; Optimized ReturnToMapChecker function with timeout
ReturnToMapChecker()
{
  Loop ; Infinite loop to ensure the "return to map" button is found
  {
    ImageSearch, FoundX, FoundY, 414, 621, 573, 646, *50 %A_WorkingDir%\images\return_to_map_button.bmp
    if (ErrorLevel = 0) ; "Return to map" button successfully found
      Return ; Exit the function only when the button is found
  }
  if (ErrorLevel != 0)
    MsgBox, Error: Unable to find the "return to map" button.
} ;state checker - checks presence of "return to map" button using image recognition

ReturnToMapPress()
{
  MouseMove, 500, 630, 1 ;return to map button
  Click
  Sleep 300
}

QPC( R := 0 )
{
  ; By SKAN,  http://goo.gl/nf7O4G,  CD:01/Sep/2014 | MD:01/Sep/2014
  Static P := 0,  F := 0,     Q := DllCall( "QueryPerformanceFrequency", "Int64P",F )
  Return ! DllCall( "QueryPerformanceCounter","Int64P",Q ) + ( R ? (P:=Q)/F : (Q-P)/F )
} ;timer, mostly for checking performance of script

ShowToolTip(message) {
  ToolTip, %message%, 10, 10
  SetTimer, RemoveToolTip, -3000  ; Removes the message after 3 seconds, but the script continues to run
}

RemoveToolTip() {
  ToolTip  ; Removes the message
}

forceSave() {
  ; Find image "joining_online_button"
  Loop
  {
    ImageSearch, FoundX, FoundY, 867, 766, 984, 783, *80 %A_WorkingDir%\images\joining_online_button.bmp
    if (ErrorLevel = 0)
    {
      break
    }
  }

  ; Wait until image is Gone → Black Screen begin
  Loop
  {
    ; Searching for black Pixel
    PixelGetColor, color, 831, 747
    if (color = 0x000000) ; Black Screen begin
    {
      break
    }
  }

  ; Wait until Black Screen is gone
  Loop
  {
    PixelGetColor, color, 831, 747
    if (color != 0x000000) ; If not black anymore
    {
      break
    }
  }

  ; Wait until "joining online"
  Loop
  {
    ImageSearch, FoundX, FoundY, 867, 766, 984, 783, *80 %A_WorkingDir%\images\joining_online_button.bmp
    if (ErrorLevel = 0)
    {
      break
    }
  }

  ; Wait until "joining online" is gone
  Loop
  {
    ImageSearch, FoundX, FoundY, 867, 766, 984, 783, *80 %A_WorkingDir%\images\joining_online_button.bmp
    if (ErrorLevel != 0)
    {
      break
    }
  }

  ; Pressing ALT + F4
  SendInput, {Alt down}
  PressKey("F4", 500, 1, 0)
  SendInput, {Alt up}
  Sleep 30

  ; Spamming ESC until message disappears
  Loop
  {
    PixelGetColor, color, 831, 747
    if (color != 0x000000)
    {
      break
    }

    PressKey("Esc", 50, 1, 0)
    Sleep, 100
  }
}